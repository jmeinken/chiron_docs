

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Data Dictionary Setup Tutorial &mdash; Chiron 1.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Built-In Processors" href="built_in_processors.html" />
    <link rel="prev" title="Installing Chiron" href="getting_started.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> Chiron
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="system_overview.html">System Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="version_changelog.html">Version Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo.html">Demo Version</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Installing Chiron</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Data Dictionary Setup Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#manual-configuration-example">Manual Configuration Example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setting-up-roots">Setting up Roots</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setting-up-source-collections">Setting up Source Collections</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setting-up-concepts">Setting up Concepts</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#automated-configuration-example">Automated Configuration Example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#step-1-create-a-model-tree-file">Step 1. Create a model tree file</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-2-add-child-models-of-your-project-root-model">Step 2. Add child models of your project root model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-3-continue-to-add-children-of-children-until-you-have-listed-all-the-models-you-want-to-import">Step 3. Continue to add children of children until you have listed all the models you want to import</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-4-mark-models-that-should-be-made-into-roots">Step 4: Mark models that should be made into roots</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-5-mark-models-that-don-t-need-their-own-category">Step 5: Mark models that don’t need their own Category</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-6-create-an-autocreate-dd-config-list-of-modeltree-file-locations">Step 6: Create an <cite>autocreate_dd_config</cite> list of modeltree file locations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-7-cleanup">Step 7: Cleanup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rerunning-autocreate-after-changes">Rerunning Autocreate After Changes</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="built_in_processors.html">Built-In Processors</a></li>
<li class="toctree-l1"><a class="reference internal" href="making_custom_processor.html">Creating Your Own Processors</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_dict_models.html">Data Dictionary Model Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="api_viewsets.html">API Endpoints</a></li>
<li class="toctree-l1"><a class="reference internal" href="api_transforming_cohort_def.html">Transforming Cohort Definitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="api_transforming_table_def.html">Transforming Table Definitions</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Chiron</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Data Dictionary Setup Tutorial</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/data_dict_example.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="data-dictionary-setup-tutorial">
<h1>Data Dictionary Setup Tutorial<a class="headerlink" href="#data-dictionary-setup-tutorial" title="Permalink to this headline">¶</a></h1>
<div class="section" id="manual-configuration-example">
<h2>Manual Configuration Example<a class="headerlink" href="#manual-configuration-example" title="Permalink to this headline">¶</a></h2>
<p>This example will be importing from the following dataset in a Django app named <code class="docutils literal notranslate"><span class="pre">my_study</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Subject</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">subject_uid</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">gender</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dob</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Race</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="s1">&#39;Subject&#39;</span><span class="p">)</span>
    <span class="n">race_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Survey</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Subject&#39;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">survey_name</span> <span class="o">=</span>  <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">survey_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">()</span>
    <span class="n">has_fever</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">()</span>
    <span class="n">bmi</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="setting-up-roots">
<h3>Setting up Roots<a class="headerlink" href="#setting-up-roots" title="Permalink to this headline">¶</a></h3>
<p>The first decision we need to make is how to set up our Roots to structure the database. We have
a <code class="docutils literal notranslate"><span class="pre">Subject</span></code> table that has a many:many relationship to <code class="docutils literal notranslate"><span class="pre">Race</span></code> and a 1:many relationship to <code class="docutils literal notranslate"><span class="pre">Survey</span></code>.</p>
<p>For data about research participants or patients, you will almost always want the person to be
the project root. So we will use <code class="docutils literal notranslate"><span class="pre">Subject</span></code> as the project root. <code class="docutils literal notranslate"><span class="pre">Survey</span></code> is longitudinal data
(one subject can have multiple surveys over time), so we will create a second root to hold
the survey data.</p>
<p><code class="docutils literal notranslate"><span class="pre">Race</span></code> is a little trickier. The model allows a single subject to specify multiple races. However,
the data is not longitudinal, and it is not a collection of related fields but simply a single
field <code class="docutils literal notranslate"><span class="pre">race_name</span></code>. For those reasons, this is a good candidate for an overloaded field. Instead
of creating a separate <code class="docutils literal notranslate"><span class="pre">Race</span></code> root, we will put the <code class="docutils literal notranslate"><span class="pre">race_name</span></code> concept in the <code class="docutils literal notranslate"><span class="pre">Subject</span></code> root and
store an array of strings whenever a subject has multiple races.</p>
<p>So in total we will have two roots:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">chiron</span> <span class="kn">import</span> <span class="n">models</span>

<span class="n">subject_root</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Root</span><span class="p">(</span>
    <span class="n">permanent_id</span><span class="o">=</span><span class="s2">&quot;subject&quot;</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;study subject&quot;</span><span class="p">,</span>
    <span class="n">is_project_root</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">subject_root</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="n">survey_root</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Root</span><span class="p">(</span>
    <span class="n">permanent_id</span><span class="o">=</span><span class="s2">&quot;survey&quot;</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;survey&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">survey_root</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="setting-up-source-collections">
<h3>Setting up Source Collections<a class="headerlink" href="#setting-up-source-collections" title="Permalink to this headline">¶</a></h3>
<p>Next we need to define our source collections and set up source collection processors.
Recall that a source collection processor needs to return a dataset as an iterable.
To populate our Subject root, we will need an iterable of subjects, and to populate our
Survey root we will need an iterable of surveys.</p>
<p>Chiron has a built-in source collection processor for getting data from the Django ORM. We will
configure two source collections - one associated with the Subject model and one with the Survey model.
Let’s start with the Subject:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># create the subject source collection</span>
<span class="n">sc_processor</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Processor</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Source Collection Processor for Django Model&quot;</span><span class="p">)</span>
<span class="n">subject_sc</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SourceCollection</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;subjects&quot;</span><span class="p">,</span>
    <span class="n">root</span><span class="o">=</span><span class="n">subject_root</span><span class="p">,</span>
    <span class="n">processor</span><span class="o">=</span><span class="n">sc_processor</span><span class="p">,</span>
    <span class="n">execution_order</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
<span class="n">subject_sc</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>We’re not finished with our subject source collection yet. The built-in Django source collection
processor class requires some
arguments when initialized. At a minimum we need to tell it which app and model to iterate.</p>
<p>There is a model <code class="docutils literal notranslate"><span class="pre">SourceCollectionProcessorArgument</span></code> to set these values:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># provide arguments to configure the subject source collection processor</span>
<span class="n">arg_app</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SourceCollectionProcessorArgument</span><span class="p">(</span>
    <span class="n">source_collection</span><span class="o">=</span><span class="n">subject_sc</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;app&quot;</span><span class="p">,</span>
    <span class="n">value</span><span class="o">=</span><span class="s2">&quot;my_study&quot;</span>
<span class="p">)</span>
<span class="n">arg_app</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="n">arg_model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SourceCollectionProcessorArgument</span><span class="p">(</span>
    <span class="n">source_collection</span><span class="o">=</span><span class="n">subject_sc</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">,</span>
    <span class="n">value</span><span class="o">=</span><span class="s2">&quot;Subject&quot;</span>
<span class="p">)</span>
<span class="n">arg_model</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>Our source collection processor is also responsible for setting an <code class="docutils literal notranslate"><span class="pre">_id</span></code> value. By default, the
processor will use the model primary key. In the <code class="docutils literal notranslate"><span class="pre">Subject</span></code> model, the primary key is an
<code class="docutils literal notranslate"><span class="pre">id</span></code> field implicitly created by Django. However, we also have a unique <code class="docutils literal notranslate"><span class="pre">subject_uid</span></code> field
that we could use.</p>
<p>Let’s use the <code class="docutils literal notranslate"><span class="pre">subject_id</span></code> field:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">arg_root_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SourceCollectionProcessorArgument</span><span class="p">(</span>
    <span class="n">source_collection</span><span class="o">=</span><span class="n">subject_sc</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;root_id&quot;</span><span class="p">,</span>
    <span class="n">value</span><span class="o">=</span><span class="s2">&quot;subject_uid&quot;</span>
<span class="p">)</span>
<span class="n">arg_root_id</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Subject</span></code> source collection is now complete. Next we will set up the <code class="docutils literal notranslate"><span class="pre">Survey</span></code> source collection the
same way:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># create the survey source collection</span>
<span class="n">survey_sc</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SourceCollection</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;surveys&quot;</span><span class="p">,</span>
    <span class="n">root</span><span class="o">=</span><span class="n">survey_root</span><span class="p">,</span>
    <span class="n">processor</span><span class="o">=</span><span class="n">sc_processor</span><span class="p">,</span>
    <span class="n">execution_order</span><span class="o">=</span><span class="mi">2</span>
<span class="p">)</span>
<span class="n">survey_sc</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="c1"># provide arguments to configure the survey source collection processor</span>
<span class="n">arg_app</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SourceCollectionProcessorArgument</span><span class="p">(</span>
    <span class="n">source_collection</span><span class="o">=</span><span class="n">survey_sc</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;app&quot;</span><span class="p">,</span>
    <span class="n">value</span><span class="o">=</span><span class="s2">&quot;my_study&quot;</span>
<span class="p">)</span>
<span class="n">arg_app</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="n">arg_model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SourceCollectionProcessorArgument</span><span class="p">(</span>
    <span class="n">source_collection</span><span class="o">=</span><span class="n">survey_sc</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">,</span>
    <span class="n">value</span><span class="o">=</span><span class="s2">&quot;Survey&quot;</span>
<span class="p">)</span>
<span class="n">arg_model</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>For surveys, we have two <code class="docutils literal notranslate"><span class="pre">_id</span></code> fields to worry about. First, we need a <code class="docutils literal notranslate"><span class="pre">root_id</span></code> which will be
a unique identifier for each survey. Then, in order to associate surveys with the appropriate subject,
we need a <code class="docutils literal notranslate"><span class="pre">project_root_id</span></code>. This will be a unique identifier for the project_root, which is the
<code class="docutils literal notranslate"><span class="pre">Subject</span></code> root.</p>
<p>For the survey ID, we can just leave it undefined and let Django use the <code class="docutils literal notranslate"><span class="pre">Survey</span></code> model primary key field.
However, the subject ID needs to match what we set previously - the <code class="docutils literal notranslate"><span class="pre">subject_uid</span></code> field in
the <code class="docutils literal notranslate"><span class="pre">Subject</span></code> model.</p>
<p>Since we’re iterating over the <code class="docutils literal notranslate"><span class="pre">Survey</span></code> model for surveys, we need to “follow” the foreign-key relationship
from Survey to Subject. The processor allows Django’s built-in double underscore syntax to do that:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">arg_project_root_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SourceCollectionProcessorArgument</span><span class="p">(</span>
    <span class="n">source_collection</span><span class="o">=</span><span class="n">survey_sc</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;project_root_id&quot;</span><span class="p">,</span>
    <span class="n">value</span><span class="o">=</span><span class="s2">&quot;subject__subject_uid&quot;</span>
<span class="p">)</span>
<span class="n">arg_root_id</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>Now that both our Subject and Survey source collection are returning <code class="docutils literal notranslate"><span class="pre">Subject.subject_uid</span></code> as
the subject ID, they will be merged in MongoDB appropriately.</p>
</div>
<div class="section" id="setting-up-concepts">
<h3>Setting up Concepts<a class="headerlink" href="#setting-up-concepts" title="Permalink to this headline">¶</a></h3>
<p>Now that our Roots and SourceCollections are all in place, we can begin defining the concepts we
want to import. For subjects we have <code class="docutils literal notranslate"><span class="pre">gender</span></code>, <code class="docutils literal notranslate"><span class="pre">race</span></code>, and <code class="docutils literal notranslate"><span class="pre">DOB</span></code>. For Surveys, we have
<code class="docutils literal notranslate"><span class="pre">survey_name</span></code>, <code class="docutils literal notranslate"><span class="pre">survey_date</span></code>, <code class="docutils literal notranslate"><span class="pre">has_fever</span></code> and <code class="docutils literal notranslate"><span class="pre">bmi</span></code>.</p>
<p>Concepts have three required processor classes:</p>
<ul class="simple">
<li><p><strong>ETL Processor</strong>: retrieves values for this concept to put in MongoDB</p></li>
<li><p><strong>Cohort Def Processor</strong>: Manages how the concept works in queries</p></li>
<li><p><strong>Display Processor</strong>: Manages how the concept works in output datasets</p></li>
</ul>
<p>The concept ETL processor works in close coordination with the source collection processor. Recall the main
function of the source collection processor is to return an iterable of records. The main function
of the ETL processor is to grab a specific value out of each of those record. Since we used the built-in
<code class="docutils literal notranslate"><span class="pre">Source</span> <span class="pre">Collection</span> <span class="pre">Processor</span> <span class="pre">for</span> <span class="pre">Django</span> <span class="pre">Model</span></code>, we will use the
corresponding <code class="docutils literal notranslate"><span class="pre">ETL</span> <span class="pre">Processor</span> <span class="pre">for</span> <span class="pre">Django</span> <span class="pre">Field</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">etl_processor</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Processor</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;ETL Processor for Django Field&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The cohort def and display processors depend on the concept data type. For gender, <code class="docutils literal notranslate"><span class="pre">category</span> <span class="pre">field</span></code>
will be a good type. We have a single built-in class that can be used for both processor roles:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">category_processor</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Processor</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Category Field Processor&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we have all the references in place to build our <code class="docutils literal notranslate"><span class="pre">gender</span></code> concept:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gender</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Concept</span><span class="p">(</span>
    <span class="n">permanent_id</span><span class="o">=</span><span class="s2">&quot;subject_gender&quot;</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;gender&quot;</span><span class="p">,</span>
    <span class="n">root</span><span class="o">=</span><span class="n">subject_root</span><span class="p">,</span>
    <span class="n">source_collection</span><span class="o">=</span><span class="n">subject_sc</span><span class="p">,</span>
    <span class="n">etl_processor</span><span class="o">=</span><span class="n">etl_processor</span><span class="p">,</span>
    <span class="n">cohort_def_processor</span><span class="o">=</span><span class="n">category_processor</span><span class="p">,</span>
    <span class="n">display_processor</span><span class="o">=</span><span class="n">category_processor</span>
<span class="p">)</span>
<span class="n">gender</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>The ETL processor requires the argument <code class="docutils literal notranslate"><span class="pre">django_field</span></code> in order to know which model field to pull:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">arg_gender_django_field</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ConceptProcessorArgument</span><span class="p">(</span>
    <span class="n">concept</span><span class="o">=</span><span class="n">gender</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;django_field&quot;</span><span class="p">,</span>
    <span class="n">value</span><span class="o">=</span><span class="s2">&quot;gender&quot;</span><span class="p">,</span>
    <span class="n">send_to_etl_processor</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">arg_gender_django_field</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">race</span></code> concept is also a category and can use the same processors as gender:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">race</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Concept</span><span class="p">(</span>
    <span class="n">permanent_id</span><span class="o">=</span><span class="s2">&quot;subject_race&quot;</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;race&quot;</span><span class="p">,</span>
    <span class="n">root</span><span class="o">=</span><span class="n">subject_root</span><span class="p">,</span>
    <span class="n">source_collection</span><span class="o">=</span><span class="n">subject_sc</span><span class="p">,</span>
    <span class="n">etl_processor</span><span class="o">=</span><span class="n">etl_processor</span><span class="p">,</span>
    <span class="n">cohort_def_processor</span><span class="o">=</span><span class="n">category_processor</span><span class="p">,</span>
    <span class="n">display_processor</span><span class="o">=</span><span class="n">category_processor</span>
<span class="p">)</span>
<span class="n">race</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>The ETL processor also requires the argument <code class="docutils literal notranslate"><span class="pre">django_field</span></code>, but this time we need to use
Django’s double-underscore syntax to get from the <code class="docutils literal notranslate"><span class="pre">Subject</span></code> model to the <code class="docutils literal notranslate"><span class="pre">Race</span></code> model:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">arg_race_django_field</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ConceptProcessorArgument</span><span class="p">(</span>
    <span class="n">concept</span><span class="o">=</span><span class="n">race</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;django_field&quot;</span><span class="p">,</span>
    <span class="n">value</span><span class="o">=</span><span class="s2">&quot;race_set__race_name&quot;</span><span class="p">,</span>
    <span class="n">send_to_etl_processor</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">arg_race_django_field</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>Let’s look at an example from the <code class="docutils literal notranslate"><span class="pre">Survey</span></code> model. We can set up a concept <code class="docutils literal notranslate"><span class="pre">Survey.survey_date</span></code>
using a similar approach to our other concepts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">survey_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Concept</span><span class="p">(</span>
    <span class="n">permanent_id</span><span class="o">=</span><span class="s2">&quot;survey_date&quot;</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;survey date&quot;</span><span class="p">,</span>
    <span class="n">root</span><span class="o">=</span><span class="n">survey_root</span><span class="p">,</span>
    <span class="n">source_collection</span><span class="o">=</span><span class="n">survey_sc</span><span class="p">,</span>
    <span class="n">etl_processor</span><span class="o">=</span><span class="n">etl_processor</span><span class="p">,</span>
    <span class="n">cohort_def_processor</span><span class="o">=</span><span class="n">category_processor</span><span class="p">,</span>
    <span class="n">display_processor</span><span class="o">=</span><span class="n">category_processor</span>
<span class="p">)</span>
<span class="n">survey_date</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="n">arg_survey_date_django_field</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ConceptProcessorArgument</span><span class="p">(</span>
    <span class="n">concept</span><span class="o">=</span><span class="n">survey_date</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;django_field&quot;</span><span class="p">,</span>
    <span class="n">value</span><span class="o">=</span><span class="s2">&quot;survey_date&quot;</span><span class="p">,</span>
    <span class="n">send_to_etl_processor</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">arg_survey_date_django_field</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="automated-configuration-example">
<h2>Automated Configuration Example<a class="headerlink" href="#automated-configuration-example" title="Permalink to this headline">¶</a></h2>
<p>Chiron has a built-in management command for auto-generating a data dictionary from a set of
Django models. The final output will usually need to be further tweaked. However, it can be
a major time-saver for a large number of fields.</p>
<p>Your source data must satisfy these rules for the auto-generator</p>
<ol class="arabic simple">
<li><p>Your data must be stored in Django models.</p></li>
<li><p>You must have a model representing the project root.</p></li>
<li><p>All models must be connected through Django model relationships.</p></li>
</ol>
<div class="section" id="step-1-create-a-model-tree-file">
<h3>Step 1. Create a model tree file<a class="headerlink" href="#step-1-create-a-model-tree-file" title="Permalink to this headline">¶</a></h3>
<p>You need to create a text file that shows how your Django model relationships are set up. This
file can go anywhere, but a good place to store it is
<cite>[YOUR PROJECT DIR]/chiron_config/autocreate/modeltree_[dataset name].txt</cite>. The first entry in this file will
be the app and model name of the model that corresponds to your project root.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># example for chiron_config/autocreate/modeltree_myapp.txt</span>

<span class="c1"># note: the reader will ignore blank lines and lines starting with #</span>

<span class="n">myapp</span><span class="o">.</span><span class="n">Subjects</span>
</pre></div>
</div>
</div>
<div class="section" id="step-2-add-child-models-of-your-project-root-model">
<h3>Step 2. Add child models of your project root model<a class="headerlink" href="#step-2-add-child-models-of-your-project-root-model" title="Permalink to this headline">¶</a></h3>
<p>A child model is any model that has a direct relationship to the project root model.
The type of relationship (1:1, 1:many, many:1, many:many) doesn’t matter. Use a dash to indicate
one step down in the hierarchy. You don’t need to specify a model’s app name unless it’s different
from the parent.</p>
<p>In the following example, demographics are stored in a separate 1:1 model, surveys and specimen are
stored in 1:many models. Specimen are in their own separate Django app, so we must specify the app
name.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># example for chiron_config/autocreate/modeltree_myapp.txt</span>

<span class="n">myapp</span><span class="o">.</span><span class="n">Subjects</span>
<span class="o">-</span><span class="n">Demographics</span>
<span class="o">-</span><span class="n">specimen_app</span><span class="o">.</span><span class="n">Specimen</span>
<span class="o">-</span><span class="n">Surveys</span>
</pre></div>
</div>
</div>
<div class="section" id="step-3-continue-to-add-children-of-children-until-you-have-listed-all-the-models-you-want-to-import">
<h3>Step 3. Continue to add children of children until you have listed all the models you want to import<a class="headerlink" href="#step-3-continue-to-add-children-of-children-until-you-have-listed-all-the-models-you-want-to-import" title="Permalink to this headline">¶</a></h3>
<p>Use multiple dashes to indicate position in the hierarchy.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># example for chiron_config/autocreate/modeltree_myapp.txt</span>

<span class="n">myapp</span><span class="o">.</span><span class="n">Subjects</span>
<span class="o">-</span><span class="n">Demographics</span>
<span class="o">--</span><span class="n">Race</span>
<span class="o">-</span><span class="n">specimen_app</span><span class="o">.</span><span class="n">Specimen</span>
<span class="o">--</span><span class="n">Freezer</span>
<span class="o">-</span><span class="n">surveys</span>
</pre></div>
</div>
</div>
<div class="section" id="step-4-mark-models-that-should-be-made-into-roots">
<h3>Step 4: Mark models that should be made into roots<a class="headerlink" href="#step-4-mark-models-that-should-be-made-into-roots" title="Permalink to this headline">¶</a></h3>
<p>The auto-creator will use a separate root for any entries followed by an asterisk. The first model
in the list corresponds to your project root and should always have an asterisk. For all other models,
the asterisk is optional based on your data. Models without an asterisk will be associated with the
closest parent containing an asterisk.</p>
<p>In the example,</p>
<p>Let’s consider each model in our example:</p>
<ul class="simple">
<li><p><strong>Demographics</strong> - Demographics is 1:1 with Subjects, so we will leave the asterisk off and associate demographic
fields directly with the Subject root.</p></li>
<li><p><strong>Race</strong> - is 1:many with demographics (one person is allowed to have multiple races). However, assuming
the Race table only has 1 field race_name, this will be a good option for an overloaded field. We
will leave off the asterisk, leaving Race field(s) associated with the Subject root. If any
subjects have multiple races listed, they will be stored as arrays with the distinct set of values found.</p></li>
<li><p><strong>Specimen</strong> - It is likely that subjects can have multiple specimen, and that specimen have
multiple values such as collection date, specimen type, amount, etc. For this reason, specimen
can be considered longitudinal data and should get their own root.</p></li>
<li><p><strong>Freezer</strong> - Let’s assume that the freezer is many:1 with Specimen, i.e. a freezer
has multiple specimen, but each specimen only has 1 freezer. Since there is only 1 freezer per
specimen, we should leave off the asterisk and associate freezer fields directly with the Specimen root.</p></li>
<li><p><strong>Surveys</strong> - If subjects complete multiple surveys, this is longitudinal data and should get its
own root. If subjects only complete a survey once, it would be better to leave off the asterisk and
associate all survey fields directly with a subject. Let’s assume the former and include an asterisk.</p></li>
</ul>
<p>So the model with roots defined will look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># example forchiron_config/autocreate/modeltree_myapp.txt</span>

<span class="n">myapp</span><span class="o">.</span><span class="n">Subjects</span><span class="o">*</span>
<span class="o">-</span><span class="n">Demographics</span>
<span class="o">--</span><span class="n">Race</span>
<span class="o">-</span><span class="n">specimen_app</span><span class="o">.</span><span class="n">Specimen</span><span class="o">*</span>
<span class="o">--</span><span class="n">Freezer</span>
<span class="o">-</span><span class="n">surveys</span><span class="o">*</span>
</pre></div>
</div>
</div>
<div class="section" id="step-5-mark-models-that-don-t-need-their-own-category">
<h3>Step 5: Mark models that don’t need their own Category<a class="headerlink" href="#step-5-mark-models-that-don-t-need-their-own-category" title="Permalink to this headline">¶</a></h3>
<p>Concepts are grouped into a hierarchy using the Category model. Keep in mind that the Category hierarchy
is completely separate from the Root hierarchy. The category only affects how the concepts are
displayed in  the UI, and has no impact on how concepts are stored or queried in MongoDB.</p>
<p>The auto-importer will create a category hierarchy that mirrors your defined model hierarchy.
Every model will get its own category. However, if you don’t want a model to get its own category,
you can put an &#64; after it. For any models marked in this way, Django will not create a separate
category but instead will associate all of its corresponding concepts with its parent model.</p>
<p>In our example, let’s add Race fields to the Demographics category and Freezer fields to the
Specimen category.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># example for modeltree_myapp.txt</span>

<span class="n">myapp</span><span class="o">.</span><span class="n">Subjects</span><span class="o">*</span>
<span class="o">-</span><span class="n">Demographics</span>
<span class="o">--</span><span class="n">Race</span><span class="o">@</span>
<span class="o">-</span><span class="n">specimen_app</span><span class="o">.</span><span class="n">Specimen</span><span class="o">*</span>
<span class="o">--</span><span class="n">Freezer</span><span class="o">@</span>
<span class="o">-</span><span class="n">surveys</span><span class="o">*</span>
</pre></div>
</div>
</div>
<div class="section" id="step-6-create-an-autocreate-dd-config-list-of-modeltree-file-locations">
<h3>Step 6: Create an <cite>autocreate_dd_config</cite> list of modeltree file locations<a class="headerlink" href="#step-6-create-an-autocreate-dd-config-list-of-modeltree-file-locations" title="Permalink to this headline">¶</a></h3>
<p>The <cite>autocreate_dd_config</cite> list tells Chiron where all your modeltree text files are. By default,
Chiron will look for this list in <cite>chiron_config/autocreate/autocreate.py</cite>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># file location chiron_config/autocreate/autocreate.py</span>

<span class="n">autocreate_dd_config</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;source_id&#39;</span> <span class="p">:</span> <span class="s1">&#39;myapp&#39;</span><span class="p">,</span>              <span class="c1"># this can be any unique ID you want</span>
        <span class="s1">&#39;modeltree_path&#39;</span> <span class="p">:</span> <span class="s1">&#39;chiron_config/autocreate/modeltree_myapp.txt&#39;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Now you can run the autocreate management command. If your <cite>autocreate_dd_config</cite> file isn’t in the
standard location, you can specify the Python module in Django settings using <cite>CHIRON_AUTOCREATE_DD_MODULE_PATH</cite>,
or you can pass it as an argument using <cite>–module</cite>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">chiron_autocreate_dd</span>
</pre></div>
</div>
</div>
<div class="section" id="step-7-cleanup">
<h3>Step 7: Cleanup<a class="headerlink" href="#step-7-cleanup" title="Permalink to this headline">¶</a></h3>
<p>Your autocreated code may require additional editing. The autocreate tool creates a separate
SourceCollection for each Root it creates. It assumes that the root_id is the primary key of the
associated model, and that the project_root_id is the primary key of that model. If you are using
different IDs in your project, you need to manually edit the processor arguments passed to
the SourceCollection.</p>
<p>There are also performance tweaks you can make with processor arguments such as
select_related, prefetch_related, and max_batch_size.</p>
</div>
<div class="section" id="rerunning-autocreate-after-changes">
<h3>Rerunning Autocreate After Changes<a class="headerlink" href="#rerunning-autocreate-after-changes" title="Permalink to this headline">¶</a></h3>
<p>There is a dedicated model <cite>AutoImportedField</cite> to keep track of all fields that have been loaded
through autocreate. Any fields that have been imported are tracked in this model and will not be
imported again, even if the associated Concepts have been modified or deleted. So it is safe
to rerun <cite>chiron_autocreate_dd</cite> after adding new modeltrees, models, or fields.</p>
<p>If you actually want to reload previously loaded concepts (for example, if you deleted something by accident),
you can remove the fields you wish to re-import from <cite>AutoImportedField</cite>, then run <cite>chiron_autocreate_dd</cite>
again.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="built_in_processors.html" class="btn btn-neutral float-right" title="Built-In Processors" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="getting_started.html" class="btn btn-neutral float-left" title="Installing Chiron" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, UC Center for Health Informatics, Cincinnati Children&#39;s Biomedical Informatics

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>